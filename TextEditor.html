<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Text Scratch Editor</title>

<style>
  body {
    margin: 0;
    height: 100vh;
    background: #0f1117;
    color: #e6e6eb;
    display: flex;
    flex-direction: column;
    font-family: ui-monospace, Consolas, monospace;
  }

  .toolbar {
    height: 42px;
    background: #161a23;
    border-bottom: 1px solid #262a36;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 10px;
  }

  button {
    background: #23283a;
    color: #e6e6eb;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
  }

  button:hover { background: #2f3560; }

  #editor { flex: 1; }

  .statusbar {
    height: 22px;
    background: #161a23;
    border-top: 1px solid #262a36;
    font-size: 11px;
    padding: 4px 8px;
    opacity: 0.7;
    display: flex;
    justify-content: space-between;
  }
</style>

<script type="module">
  import { EditorState } from "https://esm.sh/@codemirror/state";
  import { EditorView, keymap, lineNumbers, highlightActiveLine } from "https://esm.sh/@codemirror/view";
  import { defaultKeymap, history, historyKeymap } from "https://esm.sh/@codemirror/commands";
  import { indentOnInput, bracketMatching, foldGutter } from "https://esm.sh/@codemirror/language";
  import { closeBrackets, closeBracketsKeymap, autocompletion } from "https://esm.sh/@codemirror/autocomplete";
  import { StreamLanguage } from "https://esm.sh/@codemirror/language";
  import { lintGutter, linter } from "https://esm.sh/@codemirror/lint";
  import { oneDark } from "https://esm.sh/@codemirror/theme-one-dark";

  /* =====================
     SCRATCH TOKENIZER
  ===================== */
  const scratchLang = StreamLanguage.define({
    token(stream) {
      if (stream.match(/move|turn|go|point/i)) return "motion";
      if (stream.match(/repeat|forever|if|else|wait/i)) return "control";
      if (stream.match(/key|touching|mouse|pressed\?/i)) return "sensing";
      if (stream.match(/<|>|=/)) return "operator";
      if (stream.match(/\d+(\.\d+)?/)) return "number";
      if (stream.match(/".*?"/)) return "string";
      if (stream.match(/\{|\}/)) return "brace";
      stream.next();
      return null;
    }
  });

  /* =====================
     SYNTAX COLORS
  ===================== */
  const scratchTheme = EditorView.theme({
    ".cm-motion": { color: "#4c97ff" },
    ".cm-control": { color: "#ffab19" },
    ".cm-sensing": { color: "#5cb1d6" },
    ".cm-number": { color: "#c77dff" },
    ".cm-string": { color: "#ffd166" },
    ".cm-operator": { color: "#2ec4b6" }
  });

  /* =====================
     AUTOCOMPLETE
  ===================== */
  const completions = [
    "move (10) steps",
    "turn (15) degrees",
    "wait (1) seconds",
    "repeat (10) times {",
    "forever {",
    "if <key space pressed?> {",
    "else {",
    "say (\"hello\")"
  ];

  function scratchAutocomplete(ctx) {
    let word = ctx.matchBefore(/[\w<>\?]+/);
    if (!word || (word.from === word.to && !ctx.explicit)) return null;
    return {
      from: word.from,
      options: completions.map(c => ({ label: c, type: "keyword" }))
    };
  }

  /* =====================
     BASIC ERROR CHECK
  ===================== */
  const scratchLinter = linter(view => {
    const text = view.state.doc.toString();
    const errors = [];
    let depth = 0;

    for (let i = 0; i < text.length; i++) {
      if (text[i] === "{") depth++;
      if (text[i] === "}") depth--;
      if (depth < 0) {
        errors.push({
          from: i,
          to: i + 1,
          severity: "error",
          message: "Extra closing brace"
        });
        break;
      }
    }

    if (depth > 0) {
      errors.push({
        from: text.length - 1,
        to: text.length,
        severity: "error",
        message: "Missing closing brace"
      });
    }

    return errors;
  });

  /* =====================
     EDITOR INIT
  ===================== */
  const startCode =
`repeat (10) times {
  if <key space pressed?> {
    move (10) steps
  }
}`;

  const state = EditorState.create({
    doc: startCode,
    extensions: [
      lineNumbers(),
      highlightActiveLine(),
      history(),
      foldGutter(),
      indentOnInput(),
      bracketMatching(),
      closeBrackets(),
      autocompletion({ override: [scratchAutocomplete] }),
      lintGutter(),
      scratchLinter,
      keymap.of([
        ...defaultKeymap,
        ...historyKeymap,
        ...closeBracketsKeymap
      ]),
      scratchLang,
      scratchTheme,
      oneDark
    ]
  });

  const view = new EditorView({
    state,
    parent: document.getElementById("editor")
  });

  view.focus();

  /* =====================
     PENGUINMOD BRIDGE
  ===================== */
  function send(type, payload) {
    parent.postMessage({
      source: "TextScratchEditor",
      type,
      payload
    }, "*");
  }

  window.runCode = () => {
    send("run", view.state.doc.toString());
  };

  window.saveCode = () => {
    send("save", view.state.doc.toString());
  };

  window.addEventListener("message", e => {
    if (e.data?.type === "load" && typeof e.data.payload === "string") {
      view.dispatch({
        changes: {
          from: 0,
          to: view.state.doc.length,
          insert: e.data.payload
        }
      });
    }
  });
</script>
</head>

<body>
  <div class="toolbar">
    <button onclick="runCode()">â–¶ Run</button>
    <button onclick="saveCode()">ðŸ’¾ Save</button>
    <div style="margin-left:auto;opacity:.6">Text Scratch Mode</div>
  </div>

  <div id="editor"></div>

  <div class="statusbar">
    <span>Connected to PenguinMod</span>
    <span>Scratch Text Editor</span>
  </div>
</body>
</html>
