<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Text Scratch Editor</title>
<style>
html, body { margin: 0; padding: 0; height: 100%; font-family: monospace; background: #1e1e1e; color: white; display: flex; flex-direction: column; }
#topbar { height: 40px; background: #252526; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
button { background: #0e639c; border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; }
button:hover { background: #1177bb; }
#container { flex: 1; display: flex; overflow: hidden; }
#editor { flex: 1; height: 100%; }
#preview { flex: 0.4; background: #1b1b1b; border-left: 1px solid #333; overflow-y: auto; padding: 10px; }
.block { border-left: 4px solid #4FC3F7; padding: 2px 4px; margin: 2px 0; cursor: pointer; }
.motion { border-left-color: #4FC3F7; }
.control { border-left-color: #FFB74D; }
.event { border-left-color: #AED581; }
.nested { margin-left: 20px; }
.error { background: #ff4c4c33; }
</style>
</head>
<body>

<div id="topbar">
  <strong>ðŸ§  Text Scratch</strong>
  <button id="saveBtn">ðŸ’¾ Save</button>
  <button id="runBtn">â–¶ Run</button>
</div>

<div id="container">
  <div id="editor"></div>
  <div id="preview"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" } });

require(["vs/editor/editor.main"], () => {
  monaco.languages.register({ id: "scratchtext" });
  monaco.languages.setMonarchTokensProvider("scratchtext", {
    tokenizer: {
      root: [
        [/move\s*\(\d+\)\s*steps/, "motion"],
        [/turn\s*(right|left)\s*\(\d+\)\s*degrees/, "motion"],
        [/repeat\s*\(\d+\)\s*times/, "control"],
        [/forever\s*{/, "control"],
        [/if\s*<.*?>/, "control"],
        [/else\s*{/, "control"],
        [/when\s+key\s+.*?\s+pressed/, "event"],
        [/[{}]/, "delimiter"]
      ]
    }
  });

  monaco.editor.defineTheme("scratchDark", {
    base: "vs-dark",
    inherit: true,
    rules: [
      { token: "motion", foreground: "4FC3F7" },
      { token: "control", foreground: "FFB74D" },
      { token: "event", foreground: "AED581" },
      { token: "delimiter", foreground: "CCCCCC" }
    ]
  });

  const editor = monaco.editor.create(document.getElementById("editor"), {
    value: `when key space pressed {\n  repeat (10) times {\n    move (10) steps\n  }\n}`,
    language: "scratchtext",
    theme: "scratchDark",
    automaticLayout: true,
    folding: true,
    minimap: { enabled: false }
  });

  const preview = document.getElementById("preview");

  function classify(line){
    if (/move|turn/.test(line)) return "motion";
    if (/repeat|forever|if|else/.test(line)) return "control";
    if (/when key/.test(line)) return "event";
    return "other";
  }

  function parseScratchText(code) {
    const lines = code.split("\n").map(l => l.trim()).filter(Boolean);
    const stack = [{children: []}];
    lines.forEach(line => {
      if (line.endsWith("{")) {
        const block = { line, children: [], type: classify(line) };
        stack[stack.length-1].children.push(block);
        stack.push(block);
      } else if (line === "}") {
        stack.pop();
      } else {
        stack[stack.length-1].children.push({ line, type: classify(line) });
      }
    });
    return stack[0].children;
  }

  function renderPreview(blocks, container) {
    container.innerHTML = "";
    blocks.forEach(b => {
      const div = document.createElement("div");
      div.className = "block " + (b.type || "");
      div.textContent = b.line;
      container.appendChild(div);
      if (b.children) {
        const childDiv = document.createElement("div");
        childDiv.className = "nested";
        div.appendChild(childDiv);
        renderPreview(b.children, childDiv);
      }
    });
  }

  function updatePreview() {
    const code = editor.getValue();
    const parsed = parseScratchText(code);
    renderPreview(parsed, preview);
    return parsed;
  }

  editor.onDidChangeModelContent(updatePreview);
  updatePreview();

  // ================= Save & Run =================
  document.getElementById("saveBtn").onclick = () => {
    const code = editor.getValue();
    const parsed = updatePreview();
    
    // send postMessage to parent window (PenguinMod extension)
    window.parent.postMessage({
      type: "PM_TEXT_CODE_SAVE",
      source: "TextEditor",
      code,
      parsed
    }, "*");

    // Confirm alert
    alert("ðŸ’¾ Code sent to PenguinMod!");
  };

  document.getElementById("runBtn").onclick = () => {
    const code = editor.getValue();
    const parsed = updatePreview();
    
    window.parent.postMessage({
      type: "PM_TEXT_CODE_EXECUTE",
      source: "TextEditor",
      code,
      parsed
    }, "*");
  };

  // Receive code from PM extension
  window.addEventListener("message", e => {
    if (e.data?.type === "PM_TEXT_CODE_LOAD" && e.data.code) {
      editor.setValue(e.data.code);
      updatePreview();
    }
  });
});
</script>
</body>
</html>
