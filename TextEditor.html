function getCurrentWord() {
  const sel = window.getSelection();
  if (!sel.rangeCount) return "";
  const range = sel.getRangeAt(0).cloneRange();
  range.collapse(true);
  range.setStart(editor, 0);
  const text = range.toString();
  const match = text.match(/(\S+)$/); // last word
  return match ? match[1] : "";
}

editor.addEventListener("keyup", (e) => {
  if (e.key.length === 1 || e.key === "Backspace") {
    const word = getCurrentWord();
    if (word) showAutocomplete(word);
    else ac.style.display = "none";
  } else if (e.key === "Escape") ac.style.display = "none";
});

function insertAutocomplete(text) {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const range = sel.getRangeAt(0);

  // Delete current word
  const startOffset = range.startOffset;
  let node = range.startContainer;
  if (node.nodeType === 3) { // text node
    const value = node.nodeValue;
    const lastWordMatch = value.slice(0, startOffset).match(/(\S+)$/);
    if (lastWordMatch) {
      const lastWordLength = lastWordMatch[1].length;
      const newValue = value.slice(0, startOffset - lastWordLength) + value.slice(startOffset);
      node.nodeValue = newValue;
      range.setStart(node, startOffset - lastWordLength);
      range.setEnd(node, startOffset - lastWordLength);
    }
  }

  // Insert new text
  const textNode = document.createTextNode(text + " ");
  range.insertNode(textNode);

  // Move cursor after inserted text
  range.setStartAfter(textNode);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
  editor.focus();
}
