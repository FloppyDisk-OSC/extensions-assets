<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>PenguinMod Text Code Editor</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #1e1e1e;
    color: white;
    font-family: sans-serif;
  }

  #topbar {
    height: 40px;
    background: #252526;
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 10px;
  }

  button {
    background: #0e639c;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover {
    background: #1177bb;
  }

  #editor {
    height: calc(100% - 40px);
    width: 100%;
  }
</style>
</head>
<body>

<div id="topbar">
  <strong>ðŸ§  Text Code</strong>
  <button id="saveBtn">ðŸ’¾ Save & Run</button>
</div>

<div id="editor"></div>

<!-- Monaco -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script>
require.config({
  paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" }
});

require(["vs/editor/editor.main"], () => {

  // ðŸ”¤ Custom language
  monaco.languages.register({ id: "scratchtext" });

  monaco.languages.setMonarchTokensProvider("scratchtext", {
    tokenizer: {
      root: [
        [/move\s+\(\d+\)\s+steps/, "motion"],
        [/turn\s+(right|left)\s+\(\d+\)\s+degrees/, "motion"],
        [/repeat\s+\(\d+\)\s+times/, "control"],
        [/if\s+<.+?>/, "control"],
        [/when\s+key\s+.+?\s+pressed/, "event"],
        [/[{}]/, "delimiter"]
      ]
    }
  });

  monaco.editor.defineTheme("scratchDark", {
    base: "vs-dark",
    inherit: true,
    rules: [
      { token: "motion", foreground: "4FC3F7" },
      { token: "control", foreground: "FFB74D" },
      { token: "event", foreground: "AED581" }
    ]
  });

  const editor = monaco.editor.create(document.getElementById("editor"), {
    value:
`when key space pressed {
  repeat (10) times {
    move (10) steps
  }
}`,
    language: "scratchtext",
    theme: "scratchDark",
    automaticLayout: true,
    folding: true,
    minimap: { enabled: false }
  });

  // ðŸ§  Scratch-text â†’ instructions
  function parseScratchText(code) {
    const lines = code.split("\n");
    const instructions = [];

    for (let line of lines) {
      line = line.trim();

      if (line.startsWith("move")) {
        const n = line.match(/\((\d+)\)/)?.[1];
        instructions.push({ opcode: "motion_movesteps", value: Number(n) });
      }

      if (line.startsWith("repeat")) {
        const n = line.match(/\((\d+)\)/)?.[1];
        instructions.push({ opcode: "control_repeat", times: Number(n) });
      }

      if (line.startsWith("when key")) {
        const key = line.match(/key\s+(.+?)\s+pressed/)?.[1];
        instructions.push({ opcode: "event_whenkeypressed", key });
      }
    }

    return instructions;
  }

  // ðŸ’¾ Save & Run
  document.getElementById("saveBtn").onclick = () => {
    const code = editor.getValue();
    const parsed = parseScratchText(code);

    window.parent.postMessage({
      type: "PM_TEXT_CODE_EXECUTE",
      source: "TextEditor",
      code,
      parsed
    }, "*");

    alert("Sent to PenguinMod!");
  };

});
</script>

</body>
</html>
